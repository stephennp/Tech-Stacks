# Stripe

## I. Stripe config

- **.Net Core**: Add an **public and secret key** to `appsettings.json`
- **Angular** : add the **public key** to `app.constants.ts`

## II. Instal stripe CLI/ngRok for web hook

- Stripe CLI

  - Step 1 : Install Scoop package manager by **Windows PowerShell** `iwr -useb get.scoop.sh | iex`
  - Step 2 : Install the stripe CLI by Scoop

    ```csharp
        scoop bucket add stripe https://github.com/stripe/scoop-stripe-cli.git
        scoop install stripe
    ```

  - Step 3 : Type cmd `stripe login`
  - Step 4 : Type cmd `stripe listen`
  - Step 5: Type cmd, add a trigger with event you want to subscribe `stripe trigger invoice.payment_succeeded`
  - Step 6: Forward events to your server `stripe listen --forward-to localhost:32248/api/stripewebhook`

  - References:
    - [Stripe CLI docs](https://stripe.com/docs/stripe-cli)

- ngRoK

  - For example:

    ```csharp
    Forwarding "http://1235678.ngrok.io" -> "localhost:3000"
    ```

  - Click [here](https://ngrok.com/) for more details

## II. Products & Plans

### 1. Products

- There are two kinds of products: goods and services. Goods are intended for use with the Orders API while services are for subscriptions. When creating a product, use the type parameter to specify the correct one. Service-type products have the following parameters:

  - **name**: the product’s name, meant to be displayable to the customer.
  - **type**: the product’s type, which should be service when working with subscriptions.
  - **metadata**: a mapping of arbitrary keys and values that you can use to store additional information about the service in a structured format.

  **For example:** the enterprise tier of a software product or usage of an API. You'll add plans next to define this product's pricing.

  **Pseudo code**:

  ```csharp
  // Set your secret key: remember to change this to your live secret key in production
  // See your keys here: https://dashboard.stripe.com/account/apikeys
  StripeConfiguration.ApiKey = "sk_test_pSo79HcpIXYvnOkGfTm6x4ax00wcZdldFe";

  var options = new ProductCreateOptions {
      Name = "My SaaS Platform",
      Type = "service",
  };
  var service = new ProductService();
  Product product = service.Create(options);
  ```

  **Payload**:

  ```javascript
  {
    "id": "prod_GCtGtlUxryb2xz",
    "object": "product",
    "active": true,
    "attributes": [],
    "caption": null,
    "created": 1574157500,
    "deactivate_on": [],
    "description": null,
    "name": "Appvert",
    "type": "service",
    "unit_label": null,
    "updated": 1574157500,
    //...
  }
  ```

### 2. Delete a Product

- Notes:
  - Products with active pricing plans can't be deleted. If you'd like to delete this product, you must first delete all of its pricing plans

### 3. Plans

- Plans define how much and how frequently you charge for a product. This includes the base price, currency, and billing cycle for subscriptions.

  - **product**: either the ID of an existing product to associate with the plan or the properties to define a new product.
  - **amount**: what the customer is charged per subscription per interval.
  - **interval**: the billing period for the plan, which can range from a single day to a year. The interval options are day, week, month, and year. You can also use interval_count to set more customized intervals, such as billing a customer every 30 days or every 5 months.
  - **id**: a unique identifier. This is auto-generated by Stripe. You can optionally override this value, but plan ID must be unique across all plans in your Stripe account. You can, however, use the same plan ID in both live and test modes.
  - **usage_type (optional)**. When usage_type=licensed, the plan uses subscription item quantity to calculate the line item total for an invoice. This is the behavior you are accustomed to for plans. If usage_type is omitted, licensed is the default behavior
  - **tiers_mode (optional)**. Only applies when billing_scheme=tiered. Chooses between graduated and volume pricing
  - **billing_scheme (optional)**:
    - When billing_scheme=per_unit, amount must be specified—and, at the end of the billing period, the plan will be multiplied by the subscription item quantity or Usage to calculate the total for an invoice. This is the behavior you’re accustomed to. If billing_scheme is omitted, `per_unit` is the default behavior
    - When billing_scheme=tiered, then tiers must be specified and the subscription item quantity or Usage is used to calculate pricing based on the configured tiers.

**For example:** you might have a $5/month plan that provides limited access to your products, and a $15/month plan that allows full access.

**Pseudo code**:

```csharp
  var options = new PlanCreateOptions {
    Currency = "eur",
    Interval = "month",
    Nickname = "Pro Plan",
    Amount = 3000,
    Product = "prod_CHxGUqw1dyKsDM",
  };
  var service = new PlanService();
  Plan plan = service.Create(options);
```

**Payload**:

```javascript

{
  "id": "plan_GCtG6dASG8r2H5",
  "object": "plan A",
  "active": true,
  "amount": 200000,
  "amount_decimal": "200000",
  "billing_scheme": "per_unit",
  "created": 1574157500,
  "currency": "usd",
  "interval": "month",
  "interval_count": 1,
  "livemode": false,
  "product": "prod_GCtGtlUxryb2xz",
  //...
}
```

**Attributes**:

- `interval`: `One of day, week, month or year`. The frequency with which a subscription should be billed.

  - `product`: The product whose pricing this plan determines.

### 3. Changing and Deleting a Product/Plan

- Once a plan has been created:
  - Only the **Trial period and nickname can be modified**
  - **The amount, currency, and interval are fixed**
- If you delete this `product/plan`, you `won't` be able to create new `subscriptions` to it.
- `Existing subscriptions won't be affected` and will continue to be billed as usual until canceled.
- This can't be `undone`.
- If you need to change any of these parameters, a **new plan** must be created instead
- This restriction avoids the potential surprise and confusion that would arise from having different customers on the same plan but at **different price points**.
- If you’d rather charge customers the **full amount of the new plan**, cancel their subscriptions before subscribing them to the new plan. Doing so also resets the customer’s billing cycle.
- **Deleting a plan does not affect any existing subscribers** of that plan, but new customers cannot be subscribed to it
- There is also a [proration impact of the change](#1.-Proration-impact-of-the-change) when upgrade or downgrade subscription

### 4. Using plans

- **Conventional plans** (Licensed)
  - That charge a fixed amount on an interval are billed at the start of each billing cycle. With each invoice, the customer effectively pays for the next interval of service
  - **Example** :
    - This is commonly known as seat-based pricing, i.e. charging \$15 per user every month.
    - Subscribing a customer with 3 users to a $15 per-user monthly plan charges that customer $45 every month.
- **Metered plan**
  - the price paid by the customer varies based on consumption during the billing interval, so the customer pays for their usage at the end
  - **Example**:
    - A broadband provider charging per megabyte of usage every month
    - The usage total is multiplied by the plan amount instead of using a fixed quantity.
- **Subscriptions**
  - may include multiple plans, making it possible to combine metered billing and a fixed rate in the same subscription
  - the customer is charged the fixed rate at the start of the billing cycle and is charged for their metered usage at the end of the billing cycle

## III. Subscription

> Subscriptions allow you to charge a customer on a recurring basis.

**Payload**:

```javascript
{
  "id": "sub_GCsWpJzfKIHxKq",
  "object": "subscription",
  "application_fee_percent": null,
  "billing_cycle_anchor": 1574154757,
  "current_period_end": 1576746757,
  "current_period_start": 1574154757,
  "customer": "cus_G2OLrSXLhcSs91",
    "plan": {
      "id": "plan_G8Hw6X927a4xYa",
      "object": "plan",
      "active": true,
      "amount": 5000,
      "amount_decimal": "5000",
      "billing_scheme": "per_unit",
      "created": 1573096157,
      "currency": "usd",
      "interval": "month",
      "interval_count": 1,
      "product": "prod_G8HwKPxUhVA9iP",
      },
      //...
}
```

### 1. Create a subscription

- **Prerequisites**:
  - At least one product to create the subscription.

### 2. Metered billing

- Metered billing calculates your customer’s charge by totaling usage over a billing period. There are three modes of metered billing:
  - Fixed per-unit pricing by setting `billing_scheme` to per_unit. The total at the end of the period is amount × usage.
  - Volume-based pricing by setting `billing_scheme` to tiered and setting tiers_mode to volume. The total at the end of the period is the amount for the specific tier × usage. For example, given a tiering configuration of $5 for usage of 1 - 5, $4 for 6 - 10, and $3 for 11 - 20, a usage of 11 would result in a total of $33 (\$3 × 11).
  - Graduated pricing by setting `billing_scheme` to tiered and setting tiers_mode to graduated. The total at the end of the period is the sum of the amount for each tier × the usage for that particular tier. For example, given a graduated tiering configuration of $5 for usage of 1 - 5, $4 for 6 - 10, and $3 for 11 - 20, a usage of 11 would result in a total of $48 ($5 × 5 + $4 × 5 + \$3 × 1).

### 3. Tiered billing

- More complex pricing schemes are expressed through **tiered pricing**
- Tiered pricing allows you to change the cost per item as quantity or usage increases.
- Imagine a chat service that charges $2 per user for the first 10 users, then $1 per user for each user beyond the first 10.
- This can similarly be applied to metered billing: a broadband provider could charge \$30 for the first gigabyte of usage and then 50 for every subsequent gigabyte

## IV. Invoices

### 1. [Adding invoice items to a draft subscription invoice](https://stripe.com/docs/billing/invoices/subscription#adding-draft-invoice-items)

- When a subscription renews and creates an invoice, Stripe sends the invoice.created webhook event. Stripe **waits approximately one hour** before finalizing the invoice and attempting payment or sending an email.
- During that delay, the invoice is a draft and is editable. It’s possible to create invoice items on that invoice. Be certain to provide the invoice parameter when creating these invoice items, otherwise they will be added as pending items and swept up into the next subscription period.
- These invoice items behave slightly differently than invoice items automatically generated by Stripe:
  - Pending invoice items are always charged when the billing period ends for any subscription that is canceled. Canceling a customer’s subscription means only that the customer isn’t billed again if no invoice items exist.
  - Pending invoice items are not prorated when a customer’s subscription is changed.
- If there are pending invoice items that remain even after a subscription is canceled, Stripe will generate an invoice and will attempt to bill the customer for these items at the end of the next billing period. These invoice items are (similarly) not prorated when a subscription is changed.

### 2. Previewing upcoming invoices

### 3. Generating an invoice for subscription items outside the billing cycle

### 4. Pausing a subscription invoice for review

- Pause automatic collection within one hour of receiving the invoice.created event. You can do this by setting auto_advance=false in the API, or by pressing the Dashboard’s Turn off automatic billing button. This prevents Stripe from automatically attempting payment from your customer for the invoice amount, and from sending the invoice via email.
- Review the invoice.
- Once you are ready to attempt payment, resume automatic collection. You can do so either by setting auto_advance=true through the API, or by clicking the Dashboard’s Turn on automatic billing button.

## V. Billing cycles

### [1. Subscription Lifecyle](https://stripe.com/docs/billing/lifecycle#subscription-lifecycle)

- **For the first billing period**:
  - A `customer.created` event is sent, indicating that a customer record was successfully created.
  - A `customer.subscription.created` event is sent, indicating the subscription has been created.
  - An invoice is drafted and then finalized, prior to a charge attempt being made. The invoice.created and `invoice.finalized` events are sent, indicating that this invoice was issued for the first billing period.
  - A `charge.succeeded` event is sent, indicating that the customer’s payment method was successfully charged.
  - An `invoice.payment_succeeded` event is sent, indicating that the invoice was successfully marked paid.
- **After this first invoice, the following cycle of events repeats every billing period**:
  - When the subscription approaches its renewal date, an `invoice.upcoming` event is sent.
  - When the subscription period elapses, an `invoice.created` event is sent, indicating the creation of a draft invoice.
  - About `an hour after the invoice is created`, it is finalized (changes are no longer permitted), and an `invoice.finalized` event is sent. A charge is attempted, and a charge.succeeded event is sent to indicate that the payment was successful.
  - An `invoice.payment_succeeded` event is sent to indicate that the invoice was marked paid.
- You might want to take specific actions in response to certain events, such as:
  - Emailing the customer when a payment fails
  - Extending the length of time that a customer can use your service
  - Terminating access when a subscription is canceled

## VI. Events

## VI. Notes

### 1. Proration impact of the change

- To switch customers over to new plan, there will likely be a proration impact of the change in upgrade or downgrade subscription
- This is a preview of the invoice that will be billed on 4 Jan 2020. It may change if the subscription is updated.

| DESCRIPTION                                                   | QTY | UNIT PRICE      | AMOUNT        |
| ------------------------------------------------------------- | --- | --------------- | ------------- |
| 4 DEC 2019 \- 4 JAN 2020                                      |     |                 |               |
| Remaining time on Dat Gold Plan \-version 1 after 04 Dec 2019 | 1   |                 | US\$29\.98    |
| Unused time on Dat Gold Plan after 04 Dec 2019                | 1   |                 | \-US\$100\.95 |
| 4 JAN 2020 \- 4 FEB 2020                                      |     |                 |               |
| Dat Gold Plan \-version 1                                     | 1   | US\$30\.00      | US\$30\.00    |
|                                                               |     |                 |               |
|                                                               |     | Subtotal        | \-US\$40\.97  |
|                                                               |     | Total           | \-US\$40\.97  |
|                                                               |     | Applied balance | US\$40\.97    |
|                                                               |     | Amount due      | US\$0\.00     |

## VII. Webhook Events

- Click [here](https://stripe.com/docs/api/events/types) for more information

### 1. **[Security] Checking webhook signatures**

- Add webhook `endpoint_secret` to the system's webhook
  - Starts with `whsec\_` followed by a series of numbers and letters
- Verifying signatures using our official libraries
- Preventing replay attacks
- References:
  - Click [here](https://stripe.com/docs/webhooks/signatures) for more info

### 2. Retry Logic

- In live mode, Stripe attempts to deliver your webhooks for up to `three days` with an exponential back off. In the Events section of the Dashboard, you can view when the next retry will occur.

- In test mode, Stripe retries `three times over a few hours`. Webhooks cannot be manually retried after this time, though you can query for the event to reconcile your data with any missed events.

- During that time, `no payment` will be attempted unless a successful response is received.
- We’ll also notify you via email that the `webhook is failing`.

- **To summarize**:
  - If Stripe fails to receive a successful response to invoice.created, then finalizing all invoices with automatic collection will be `delayed for up to 72 hours`. Responding properly to invoice.created includes handling all webhook endpoints configured for your account, along with the webhook endpoints of any platforms to which you’ve connected. Updating a subscription in a way that synchronously attempts payment (on the initial invoice, and on some kinds of updates) does not cause this webhook wait.

### 3. Events Renewal of subscription

- When a customer's subscription is renewed in Stripe a number of things happen, each with a corresponding event:

  - An invoice is created - `invoice.created`
  - The subscription billing period is updated - `customer.subscription.updated`
  - After an hour (giving you time to add any additional charges) Stripe attempts to charge the customer.
  - Given payment is successful an `invoice.payment_succeeded` event is raised.

- The way to handle these events within your own application is to register a webhook; a HTTP endpoint that Stripe will send details of the event to.
  - Find the customer subscription using the Stripe identifier (included in the event payload).
  - Retrieve the subscription details from the Stripe API.
  - Update our subscription's `CurrentPeriodStart` and `CurrentPeriodEnd` with the Stripe subscription's `period_start` and `period_end`.
  - Create a customer invoice using the details from the Stripe event.

### 4. Common uses of webhooks with subscriptions

- **Handling payment failures**
  - Webhook notifications provide a reliable way to be notified of payment failures on subscription invoices.
  - A payment failure can be a temporary problem—the card issuer declined this charge but may allow the automatic retry—or indicative of a permanent blocker, such as not having a usable payment method.
  - We’ve written up a recipe that walks through accepting and processing payment failure notifications so you can automatically email your customer when it happens.
  - For full details on how to handle payment failures read [the subscription signup & payment flow documentation](https://stripe.com/docs/billing/subscriptions/payment#handling-failure).
- **Handling payments that require additional action**

  - Some payment methods may require additional steps, such as customer authentication, to complete.
  - When an invoice’s payment requires additional action, you’ll receive an `invoice.payment_action_required` webhook
  - Upon receiving this event notification, your application will need to notify the customer to complete the required action

- **Tracking active subscriptions**
  - If a customer subscribes to a monthly plan, you would initially store this timestamp value (it may be called current_period_end), adding perhaps a day or two for leeway. When the customer logs in, you’d verify the login credentials and check the current_period_end timestamp to confirm that it’s still in the future, and therefore an active account.
  - When the subscription is `renewed` (i.e., **when Stripe bills the customer and they are charged again**) your site is notified via webhooks of the additional payment:
    - A few days prior to renewal, your site receives an `invoice.upcoming` event at the webhook endpoint. You can listen for this event to [add extra invoice items]() to a subscription draft invoice.
    - Your site receives an `invoice.payment_succeeded` event.
    - Your webhook endpoint finds the customer for whom payment was just made.
    - Your webhook endpoint updates the customer’s `current_period_end` timestamp in your database to the appropriate date in the future (plus a day or two for leeway).
- **Catching subscription state changes**
  - When a subscription is about to move from **trialing** to **active**, you’ll receive a `customer.subscription.trial_will_end` event. Upon receiving this event notification, your webhook script might ensure there’s a payment method on the customer so they can be billed, and optionally notify the customer that a charge is forthcoming.
  - When a subscription changes to past_due, your webhook script could email you about the problem so you can reach out to the customer, or the script could email the customer directly, asking them to update their payment details.
- When a subscription changes to **canceled** or **unpaid**, your webhook script should ensure the customer is no longer receiving your products or services.

### 5. Best practices for testing Stripe webhook event processing

- <https://blog.launchdarkly.com/best-practices-for-testing-stripe-webhook-event-processing>

## VIII. Configuration

1. Subscriptions and emails

a. Prevent failed payments

> Configure whether you'd like to email customers to keep their payment information up to date.

    - **Upcoming renewal events**:
      - Create an event for upcoming invoices `7 (default)` days before a subscription renews
    - Send emails about upcoming renewals
    - Send emails about expiring cards

b. Manage failed payments

> Configure the steps you'd like to take when charging a customer's payment method fails.

- **Retry schedule**: `invoice.payment_failed`
  - **Default**: Retry up to 4 times within `3 weeks`
  - **Custom** retry schedule
- Send emails when card payments fail
- If all retries for a payment fail:
  - Cancel the subscription
  - Mark the subscription as unpaid
  - Leave the subscription as is
- For example:

  ```javascript
  Attempted to charge the customer
  payment method on file once and failed on 12/18/2019. Payment will be retried on 23 Dec.
  ```

c. Manage payments that require 3D Secure - Enable 3D Secure - If a recurring payment is incomplete for `15 days(default)` then `cancel the subscription`

d. Manage invoices sent to customers - (default) Email finalized invoices to customers - Send reminders if an invoice hasn't been paid - If an invoice is past due by `60 days(default)` - Cancel the subscription - Mark the subscription as unpaid - (default)Leave the subscription as is

## VII. Test the integration

- There are several test cards you can use in test mode to make sure your integration is ready. At a minimum, use the cards listed below to test your integration.
- You can use these cards with any CVC, postal code, and future expiration date

| NUMBER              | DESCRIPTION                                                                                                                                                            |
| ------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 4242 4242 4242 4242 | Succeeds and immediately creates an active subscription.                                                                                                               |
| 4000 0025 0000 3155 | Requires authentication. confirmCardPayment will trigger a modal asking for the customer to authenticate. Once the user confirms, the subscription will become active. |
| 4000 0082 6000 3178 | Always fails with a decline code of insufficient_funds.                                                                                                                |
| 4100000000000019    | Results in a charge with a risk_level of highest. The charge is blocked as it's considered fraudulent.                                                                 |

- Notes:
  **4100000000000019** : user for checking `declined-card and failed payment`
- More test card numbers and token [here](https://stripe.com/docs/testing#cards):

## VIII. Change Logs

### 1. Plans become products with plans

- If you are upgrading from an earlier version of the API, all of your existing plans have a corresponding product in the product list.
- When you navigate into a particular product, it lists the pricing plans for that product.
- **If you upgraded from an API version earlier than 2018-02-05, each Product has exactly one Plan**.
  - Click [here](https://stripe.com/docs/upgrades#2018-02-05) for more details
- When your pricing needs expand, you can add more pricing plans to your products to implement pricing experiments or to vary pricing by region or currency

### 2.Many prices for a product

- The largest functional difference in version 2018-02-05 is the ability to represent multiple prices for the same product.
- **Multiple plans for a Product** are available only from API version **2018-02-05 onward**. Until you upgrade your API Version to 2018-02-05 or later

### 3. API changes

- The APIs have undergone a number of changes that make it easier for users to implement their desired billing models.
- You won’t be required to change the way you create subscriptions after the upgrade
- However, with `tiered pricing`, you may find it easier to model your pricing by changing your product and plan structure

### 4. Keep track of changes and upgrade to Stripe API

- Click [here](https://stripe.com/docs/upgrades#2018-02-05) for more details

### 5. References

- [Migrating to Products & Plans](https://stripe.com/docs/billing/migration/products-and-plans)
