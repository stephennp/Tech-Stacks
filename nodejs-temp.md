## Use a Template Engine's Powers

- One of the greatest features of using a template engine is being able to pass variables from the server to the template file before rendering it to HTML.

- In your Pug file, you're able to use a variable by referencing the variable name as #{variable_name} inline with other text on an element or by using an equal sign on the element without a space such as p=variable_name which assigns the variable's value to the p element's text.

- We strongly recommend looking at the syntax and structure of Pug here on GitHub's README. Pug is all about using whitespace and tabs to show nested elements and cutting down on the amount of code needed to make a beautiful site.

- Looking at our pug file 'index.pug' included in your project, we used the variables title and message.

- To pass those along from our server, you will need to add an object as a second argument to your res.render with the variables and their values. For example, pass this object along setting the variables for your index view: {title: 'Hello', message: 'Please login'}

- It should look like: res.render(process.cwd() + '/views/pug/index', {title: 'Hello', message: 'Please login'}); Now refresh your page and you should see those values rendered in your view in the correct spot as laid out in your index.pug file!

## Set up Passport

- It's time to set up Passport so we can finally start allowing a user to register or login to an account! In addition to Passport, we will use `Express-session` to handle sessions. Using this `middleware` saves the `session id` as a `cookie` in the client and allows us to access the session data using that `id` on the server. This way we keep personal account information out of the cookie used by the client to verify to our server they are authenticated and just keep the `key` to access the data `stored` on the `server`.

- To set up Passport for use in your project, you will need to add it as a dependency first in your package.json. `"passport": "^0.3.2"`

- In addition, add `Express-session` as a dependency now as well. Express-session has a ton of advanced features you can use but for now we're just going to use the basics! `"express-session": "^1.15.0"`

- You will need to set up the session settings now and initialize Passport. Be sure to first create the variables 'session' and 'passport' to require `'express-session'` and `'passport'` respectively.

- To set up your express app to use the session we'll define just a few basic options. Be sure to add `SESSION_SECRET` to your `.env` file and give it a random value. This is used to compute the hash used to encrypt your cookie!

```javascript
app.use(
  session({
    secret: process.env.SESSION_SECRET,
    resave: true,
    saveUninitialized: true,
    cookie: { secure: false },
  })
);
```

- As well you can go ahead and tell your express app to use 'passport.initialize()' and 'passport.session()'. (For example, app.use(passport.initialize());)

## Serialization and Deserialization of a User Object

- `Serialization and deserialization` are important concepts in regards to authentication. To serialize an object means to convert its contents into a small key that can then be deserialized into the original object. This is what allows us to know who has communicated with the server without having to send the authentication data, like the username and password, at each request for a new page.
- Serialization:
    - Determines which data of the user object should be stored in the session. The result of the serializeUser method is attached to the session as req.session.passport.user = {}.
    - Here for instance, it would be (as we provide the user id as the key) req.session.passport.user = {id: 'xyz'}

- To set this up properly, we need to have a serialize function and a deserialize function. In Passport, we create these with passport.`serializeUser( OURFUNCTION )` and `passport.deserializeUser( OURFUNCTION )`

- The serializeUser is called with 2 arguments, the full user object and a callback used by passport. A unique key to identify that user should be returned in the callback, the easiest one to use being the user's \_id in the object. It should be unique as it generated by MongoDB. Similarly, deserializeUser is called with that key and a callback function for passport as well, but, this time, we have to take that key and return the full user object to the callback. To make a query search for a Mongo \_id, you will have to create const ObjectID = require('mongodb').ObjectID;, and then to use it you call new ObjectID(THE_ID). Be sure to add MongoDB as a dependency. You can see this in the examples below:

```javascript
passport.serializeUser((user, done) => {
  done(null, user._id);
});

passport.deserializeUser((id, done) => {
  myDataBase.findOne({ _id: new ObjectID(id) }, (err, doc) => {
    done(null, null);
  });
});
```

- NOTE: This deserializeUser will throw an error until we set up the DB in the next step, so for now comment out the whole block and just call done(null, null) in the function deserializeUser.

## Implement the Serialization of a Passport User
- Right now, we're not loading an actual user object since we haven't set up our database. This can be done many different ways, but for our project we will connect to the database once when we start the server and keep a persistent connection for the full life-cycle of the app. To do this, add your database's connection string (for example: mongodb+srv://:@cluster0-jvwxi.mongodb.net/?retryWrites=true&w=majority) to the environment variable MONGO_URI. This is used in the connection.js file.

- You can set up a free database on MongoDB Atlas.

- Now we want to connect to our database then start listening for requests. The purpose of this is to not allow requests before our database is connected or if there is a database error. To accomplish this, you will want to encompass your serialization and your app routes in the following code:

```javascript
myDB(async client => {
  const myDataBase = await client.db('database').collection('users');

  // Be sure to change the title
  app.route('/').get((req, res) => {
    //Change the response to render the Pug template
    res.render('pug', {
      title: 'Connected to Database',
      message: 'Please login'
    });
  });

  // Serialization and deserialization here...

  // Be sure to add this...
}).catch(e => {
  app.route('/').get((req, res) => {
    res.render('pug', { title: e, message: 'Unable to login' });
  });
});
// app.listen out here...
```
- Be sure to uncomment the myDataBase code in deserializeUser, and edit your done(null

# References:
 - https://stackoverflow.com/questions/27637609/understanding-passport-serialize-deserialize